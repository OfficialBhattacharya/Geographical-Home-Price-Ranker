# MSA Calibration Model - Script Documentation

## Overview

The `msaCalibration_oneShot.py` script is the final step in the forecasting pipeline, designed to refine and improve the MSA-level predictions generated by the `msaBaseline_oneShot.py` script. It calibrates the initial baseline projections by incorporating additional, potentially more recent, MSA-specific data.

The script loads the MSA baseline results, merges them with new MSA features, retrains models for each MSA, and produces a final, calibrated forecast.

## Key Features

- **Model Calibration**: Adjusts initial MSA baseline forecasts using new data to improve accuracy.
- **Data Integration**: Merges two key datasets: the output of the MSA baseline model and a file with new MSA-level features.
- **Region-Specific Modeling**: The calibration process is performed independently for each MSA, ensuring that the adjustments are tailored to the unique characteristics of each region.
- **Ensemble Approach**: Utilizes a set of robust models (Ridge, Random Forest, XGBoost) to generate the calibrated forecast.
- **Automated Workflow**: The script automates the process of loading, merging, feature engineering, training, and prediction.

## Input Data Requirements

The script requires two primary CSV files.

### 1. MSA Baseline Results (`MSA_Baseline_Results.csv`)
This is the output file generated by the `msaBaseline_oneShot.py` script. It contains the initial projections.

**Expected Columns:**
- `Year_Month_Day`: Date column.
- `rcode`, `cs_name`: MSA identifiers.
- `ProjectedHPA1YFwd_MSABaseline`: The initial MSA projection to be calibrated.
- `HPA1Yfwd`: The actual 1-year forward HPA (target variable).
- And other columns from the baseline output.

### 2. New MSA Data (`msa_data.csv`)
This file contains new or updated features for each MSA. These features are used to adjust the baseline forecast.

**Expected Format:**
```csv
Year_Month_Day,rcode,cs_name,NewFeature1,NewFeature2,...
2022-01-01,12345,Metro Area 1,0.85,3500,...
2022-02-01,12345,Metro Area 1,0.86,3510,...
...
```
**Required Columns:**
- `Year_Month_Day`, `rcode`, `cs_name`: For merging with the baseline data.
- Additional feature columns to be used in the calibration model.

## Usage

The script can be run using default paths or by providing custom paths to the data files.

### Method 1: Default Configuration
This runs the pipeline with hardcoded default file paths.
```python
# Run with default settings
main()
```

### Method 2: Custom File Paths
This method provides full control over the input and output files and other parameters.
```python
# Run with your specific data files and configurations
run_with_custom_paths(
    msa_baseline_path="path/to/your/msa_baseline_output.csv",
    msa_new_data_path="path/to/your/new_msa_data.csv",
    output_path="path/to/your/calibration_output.csv"
)
```

### Method 3: Interactive Configuration
This will prompt the user to enter all file paths and column names in the console.
```python
# Get user input for all configurations
cfg = CFG(get_user_input=True)
# ... then run the pipeline using the cfg object
```

## Model Architecture

### 1. Data Merging and Preparation
- The script first loads the MSA baseline results and the new MSA data.
- It performs an outer merge on these two datasets using the MSA identifiers (`rcode`, `cs_name`) and the date column.
- Forward-looking variables are created, and train/test tags are assigned based on the availability of the target variable (`HPA1Yfwd`).

### 2. Feature Engineering
- The initial `ProjectedHPA1YFwd_MSABaseline` serves as a key feature.
- The new features from `msa_data.csv` are incorporated.
- The script can be extended to create additional features like lags and moving averages from the combined dataset.

### 3. Calibration Modeling
- For each MSA, a new set of models (`Ridge`, `RandomForestRegressor`, `XGBoost`) is trained.
- The model learns to predict the actual `HPA1Yfwd` using the initial baseline projection and the new features as inputs. This process effectively learns to correct the errors in the initial baseline forecast.
- **Train/Test Split**: Data is split chronologically. The model is trained on periods where the future target is known and predicts for the periods where it is not.

### 4. Processing Flow
1. **Validate Paths**: Checks if the input files exist and are accessible.
2. **Load and Merge**: Loads the two input files and merges them into a single DataFrame.
3. **Data Integrity Checks**: Validates that required columns exist in the merged data.
4. **Create Targets and Tags**: Defines the target variable and splits data into training and testing sets.
5. **Process by Region**: Iterates through each MSA (`rcode`):
    - Fills any missing data for that region.
    - Trains the calibration models on the region's training data.
    - Generates a new, calibrated prediction for the region's test data.
6. **Compile and Save**: Combines the results from all MSAs and saves the final calibrated output to a CSV file.

## Output Description

The final output CSV file (`MSA_Calibration_Results.csv`) contains the calibrated predictions.

- **[Identifier Columns]**: `Year_Month_Day`, `rcode`, `cs_name`.
- **[Original Data]**: Columns from the merged input files.
- **ProjectedHPA1YFwd_MSACalibrated**: The **main output** of the script. This is the final, refined forecast for the 1-year forward HPA for each MSA.
- `tag`: 'train' or 'test' to indicate if the row was used for training or prediction.

## Dependencies
```
pandas
numpy
scikit-learn
xgboost
lightgbm
matplotlib
seaborn
statsmodels
``` 